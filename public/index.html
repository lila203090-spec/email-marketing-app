<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Marketing System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); max-width: 400px; width: 100%; }
        .login-box h1 { text-align: center; margin-bottom: 30px; color: #2c3e50; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ecf0f1; border-radius: 5px; font-size: 14px; }
        .login-box button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .error-msg { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; }
        #app { display: none; }
        .top-bar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; }
        .container { display: flex; height: calc(100vh - 60px); }
        .sidebar { width: 300px; background: #34495e; color: white; overflow-y: auto; padding: 20px; }
        .sidebar h3 { color: #3498db; margin: 20px 0 10px 0; font-size: 1.1em; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        .main-panel { flex: 1; background: #ecf0f1; padding: 20px; overflow-y: auto; }
        .control-panel { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-row { display: grid; grid-template-columns: 140px 1fr; gap: 15px; margin-bottom: 15px; }
        .form-row label { font-weight: 600; padding-top: 8px; }
        .form-row input, .form-row textarea { width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; margin: 3px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .email-list { max-height: 300px; overflow-y: auto; background: #2c3e50; border-radius: 5px; padding: 10px; margin-bottom: 20px; }
        .email-item { padding: 8px; background: #34495e; margin-bottom: 5px; border-radius: 3px; font-size: 13px; }
        .merge-tag { display: inline-block; background: #3498db; color: white; padding: 5px 12px; margin: 3px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .file-upload-box { border: 2px dashed #bdc3c7; padding: 20px; text-align: center; border-radius: 5px; cursor: pointer; }
        .attachment-item { background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .progress-bar { width: 100%; height: 30px; background: #ecf0f1; border-radius: 15px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); width: 0%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .log-container { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 250px; overflow-y: auto; }
        .admin-panel { background: white; border-radius: 10px; padding: 20px; margin: 20px; }
        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th, .user-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .user-table th { background: #34495e; color: white; }
        .status-active { color: #27ae60; font-weight: bold; }
        .status-inactive { color: #e74c3c; font-weight: bold; }
        .account-item { background: #2c3e50; padding: 8px; margin: 5px 0; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }
        .remove-account-btn { background: #e74c3c; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .remove-account-btn:hover { background: #c0392b; }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>üìß Email Marketing</h1>
            <div id="loginError" class="error-msg" style="display: none;"></div>
            <input type="text" id="loginUsername" placeholder="Username" onkeypress="if(event.key=='Enter')login()">
            <input type="password" id="loginPassword" placeholder="Password" onkeypress="if(event.key=='Enter')login()">
            <button onclick="login()">Login</button>
            <div style="text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 13px;">
                Contact administrator for credentials
            </div>
        </div>
    </div>

    <div id="app">
        <div class="top-bar">
            <h1>üìß Email Marketing System</h1>
            <div class="user-info">
                <div class="user-badge">üë§ <span id="currentUser"></span> (<span id="userRole"></span>)</div>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="adminPanel" style="display: none;">
            <div class="admin-panel">
                <h2>üëë Admin Dashboard</h2>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
                    <div style="background: #3498db; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="adminTotalUsers">0</div>
                        <div>Total Users</div>
                    </div>
                    <div style="background: #27ae60; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="adminActiveUsers">0</div>
                        <div>Active Users</div>
                    </div>
                    <div style="background: #f39c12; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="adminTotalSent">0</div>
                        <div>Total Sent</div>
                    </div>
                    <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="adminTotalFailed">0</div>
                        <div>Total Failed</div>
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="showCreateUser()">‚ûï Create User</button>
                    <button class="btn btn-primary" onclick="loadUsers()">üîÑ Refresh</button>
                </div>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Limit</th>
                            <th>Sent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="userPanel" style="display: none;">
            <div class="container">
                <div class="sidebar">
                    <h3>üìã Recipients (<span id="emailCount">0</span>)</h3>
                    <input type="email" id="singleEmail" placeholder="Add email..." style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 3px; border: 1px solid #555;">
                    <button class="btn btn-primary" onclick="addEmail()" style="width: 100%;">‚ûï Add</button>
                    <div class="email-list" id="emailList"></div>
                    <button class="btn btn-danger" onclick="clearEmails()" style="width: 100%; margin-bottom: 10px;">üóëÔ∏è Clear</button>
                    <button class="btn btn-warning" onclick="importCSV()" style="width: 100%;">üì• CSV</button>

                    <h3>üìß Sender Accounts</h3>
                    <input type="email" id="senderEmail" placeholder="Gmail" style="width: 100%; padding: 8px; margin-bottom: 5px; border-radius: 3px; border: 1px solid #555;">
                    <input type="password" id="senderPassword" placeholder="App Password (no spaces)" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 3px; border: 1px solid #555;">
                    <button class="btn btn-success" onclick="addAccount()" style="width: 100%;">‚ûï Add</button>
                    <div id="accountList" style="margin-top: 10px; font-size: 13px;"></div>

                    <h3>üìä Stats</h3>
                    <div style="background: #2c3e50; padding: 15px; border-radius: 5px;">
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 0.9em; opacity: 0.8;">Sent</div>
                            <div style="font-size: 1.5em; color: #27ae60;" id="userTotalSent">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.8;">Limit</div>
                            <div style="font-size: 1.5em; color: #f39c12;" id="userDailyLimit">500</div>
                        </div>
                    </div>
                </div>

                <div class="main-panel">
                    <div class="control-panel">
                        <h2>üìù Compose</h2>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                            <strong>Tags:</strong>
                            <span class="merge-tag" onclick="insertTag('{Email}')">{Email}</span>
                            <span class="merge-tag" onclick="insertTag('{FirstName}')">{FirstName}</span>
                            <span class="merge-tag" onclick="insertTag('{LastName}')">{LastName}</span>
                            <span class="merge-tag" onclick="insertTag('{Company}')">{Company}</span>
                        </div>
                        <div class="form-row">
                            <label>From:</label>
                            <input type="text" id="fromName" value="Marketing">
                        </div>
                        <div class="form-row">
                            <label>Subject:</label>
                            <input type="text" id="emailSubject" value="Hello {FirstName}!">
                        </div>
                        <div class="form-row">
                            <label>Body:</label>
                            <textarea id="emailBody" style="min-height: 120px;">Hi {FirstName},

Hope this finds you well!

Best regards</textarea>
                        </div>
                        <div class="form-row">
                            <label>üìé Files:</label>
                            <div>
                                <div class="file-upload-box" onclick="document.getElementById('fileInput').click()">
                                    üìé Click to attach
                                </div>
                                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFiles(event)">
                                <div id="attachmentList"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Delay:</label>
                            <input type="number" id="sendDelay" value="60" min="10">
                        </div>
                        <button class="btn btn-warning" onclick="sendTest()">üìß Test</button>
                    </div>

                    <div style="background: white; border-radius: 10px; padding: 20px;">
                        <h2>üöÄ Campaign</h2>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                        <div style="text-align: center; margin: 20px 0;">
                            <button class="btn btn-success" onclick="startCampaign()" style="font-size: 18px; padding: 15px 40px;">
                                üöÄ Start
                            </button>
                        </div>
                        <div class="log-container" id="logContainer">
                            <div>> Ready</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin + '/api';
        let currentRole = null;
        let userData = null;
        let uploadedFiles = [];

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    currentRole = data.role;
                    document.getElementById('currentUser').textContent = data.username;
                    document.getElementById('userRole').textContent = data.role;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    if (data.role === 'admin') {
                        document.getElementById('adminPanel').style.display = 'block';
                        loadUsers();
                        loadAdminStats();
                    } else {
                        document.getElementById('userPanel').style.display = 'block';
                        loadUserData();
                    }
                } else {
                    showLoginError(data.error);
                }
            } catch (e) {
                showLoginError('Connection error');
            }
        }

        function showLoginError(msg) {
            const err = document.getElementById('loginError');
            err.textContent = msg;
            err.style.display = 'block';
        }

        async function logout() {
            await fetch(`${API}/auth/logout`, { method: 'POST', credentials: 'include' });
            location.reload();
        }

        async function loadUsers() {
            const res = await fetch(`${API}/admin/users`, { credentials: 'include' });
            const data = await res.json();
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = data.users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td class="${u.active ? 'status-active' : 'status-inactive'}">${u.active ? 'Active' : 'Inactive'}</td>
                    <td>${u.dailyLimit}</td>
                    <td>${u.stats.totalSent}</td>
                    <td>
                        <button class="btn btn-warning" onclick="toggleUser('${u.id}', ${!u.active})">${u.active ? 'Deactivate' : 'Activate'}</button>
                        <button class="btn btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadAdminStats() {
            const res = await fetch(`${API}/admin/stats`, { credentials: 'include' });
            const data = await res.json();
            document.getElementById('adminTotalUsers').textContent = data.stats.totalUsers;
            document.getElementById('adminActiveUsers').textContent = data.stats.activeUsers;
            document.getElementById('adminTotalSent').textContent = data.stats.totalSent;
            document.getElementById('adminTotalFailed').textContent = data.stats.totalFailed;
        }

        function showCreateUser() {
            const username = prompt('Username:');
            if (!username) return;
            const password = prompt('Password:');
            if (!password) return;
            const email = prompt('Email:');
            if (!email) return;
            const dailyLimit = prompt('Daily limit:', '500');
            createUser(username, password, email, dailyLimit);
        }

        async function createUser(username, password, email, dailyLimit) {
            const res = await fetch(`${API}/admin/create-user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ username, password, email, dailyLimit: parseInt(dailyLimit) })
            });
            const data = await res.json();
            if (data.success) {
                alert('User created!');
                loadUsers();
                loadAdminStats();
            } else {
                alert('Error: ' + data.error);
            }
        }

        async function toggleUser(userId, active) {
            await fetch(`${API}/admin/update-user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ userId, active })
            });
            loadUsers();
        }

        async function deleteUser(userId) {
            if (!confirm('Delete?')) return;
            await fetch(`${API}/admin/delete-user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ userId })
            });
            loadUsers();
            loadAdminStats();
        }

        async function loadUserData() {
            const res = await fetch(`${API}/user/data`, { credentials: 'include' });
            const data = await res.json();
            userData = data.data;
            updateEmailList();
            updateAccountList();
            document.getElementById('userTotalSent').textContent = userData.stats.totalSent;
            document.getElementById('userDailyLimit').textContent = userData.dailyLimit;
        }

        function updateEmailList() {
            const list = document.getElementById('emailList');
            document.getElementById('emailCount').textContent = userData.emails.length;
            if (userData.emails.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #95a5a6; padding: 20px;">No emails</div>';
            } else {
                list.innerHTML = userData.emails.map(e => `<div class="email-item">${e.email}</div>`).join('');
            }
        }

        function updateAccountList() {
            const list = document.getElementById('accountList');
            if (userData.senderAccounts.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #95a5a6; padding: 20px;">No accounts</div>';
            } else {
                list.innerHTML = userData.senderAccounts.map((a, i) => `
                    <div class="account-item">
                        <div>${a.email} (${a.sent})</div>
                        <button class="remove-account-btn" onclick="removeAccount(${i})">‚úï</button>
                    </div>
                `).join('');
            }
        }

        async function removeAccount(index) {
            if (!confirm('Remove this account? You will need to logout and login again for this to persist.')) return;
            userData.senderAccounts.splice(index, 1);
            updateAccountList();
            addLog('‚úì Account removed. Logout and login again to save permanently.');
        }

        async function addEmail() {
            const email = document.getElementById('singleEmail').value.trim();
            if (!email) return;
            await fetch(`${API}/user/add-email`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ email })
            });
            document.getElementById('singleEmail').value = '';
            loadUserData();
        }

        async function clearEmails() {
            if (!confirm('Clear all?')) return;
            await fetch(`${API}/user/clear-emails`, { method: 'POST', credentials: 'include' });
            loadUserData();
        }

        async function addAccount() {
            const email = document.getElementById('senderEmail').value.trim();
            const password = document.getElementById('senderPassword').value.trim().replace(/\s/g, '');
            
            if (!email || !password) {
                alert('Enter both email and password');
                return;
            }
            
            if (password.includes(' ')) {
                alert('Remove all spaces from app password!');
                return;
            }
            
            try {
                const res = await fetch(`${API}/user/add-account`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('senderEmail').value = '';
                    document.getElementById('senderPassword').value = '';
                    loadUserData();
                    addLog('‚úì Account added: ' + email);
                    alert('Account added successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function handleFiles(e) {
            const formData = new FormData();
            Array.from(e.target.files).forEach(f => formData.append('files', f));
            try {
                const res = await fetch(`${API}/user/upload`, { method: 'POST', credentials: 'include', body: formData });
                const data = await res.json();
                if (data.success) {
                    uploadedFiles = data.files;
                    displayAttachments();
                    addLog('‚úì Files uploaded: ' + data.files.length);
                } else {
                    alert('Upload failed: ' + data.error);
                }
            } catch (e) {
                alert('Upload error: ' + e.message);
            }
        }

async function removeAccount(index) {
    if (!confirm('Remove this account permanently?')) return;
    
    try {
        const res = await fetch(`${API}/user/remove-account`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ index: index })
        });
        
        const data = await res.json();
        
        if (data.success) {
            addLog('‚úì Account removed permanently');
            loadUserData(); // Reload fresh data
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}
                });
                const data = await res.json();
                if (data.success) {
                    alert('Test email sent! Check inbox/spam.');
                    addLog('‚úì Test sent to: ' + testEmail);
                } else {
                    alert('Failed: ' + data.error);
                    addLog('‚úó Failed: ' + data.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function startCampaign() {
            if (userData.emails.length === 0) {
                alert('Add recipients');
                return;
            }
            if (userData.senderAccounts.length === 0) {
                alert('Add Gmail account first');
                return;
            }
            if (!confirm(`Send to ${userData.emails.length}?`)) return;
            try {
                const res = await fetch(`${API}/user/send-campaign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        recipients: userData.emails,
                        subject: document.getElementById('emailSubject').value,
                        body: document.getElementById('emailBody').value,
                        fromName: document.getElementById('fromName').value,
                        delay: parseInt(document.getElementById('sendDelay').value),
                        attachments: uploadedFiles
                    })
                });
                const data = await res.json();
                if (data.success) {
                    addLog('‚úì Campaign started!');
                    simulateProgress();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function simulateProgress() {
            let p = 0;
            const interval = setInterval(() => {
                if (p >= 100) {
                    clearInterval(interval);
                    addLog('‚úì Complete!');
                    loadUserData();
                    return;
                }
                p += 5;
                document.getElementById('progressFill').style.width = p + '%';
                document.getElementById('progressFill').textContent = p + '%';
            }, 2000);
        }

        function insertTag(tag) {
            const textarea = document.getElementById('emailBody');
            const pos = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, pos) + tag + textarea.value.substring(pos);
        }

        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = async ev => {
                    const lines = ev.target.result.split('\n');
                    for (let i = 1; i < lines.length; i++) {
                        const email = lines[i].split(',')[0].trim();
                        if (email) {
                            await fetch(`${API}/user/add-email`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ email })
                            });
                        }
                    }
                    loadUserData();
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function addLog(msg) {
            const log = document.getElementById('logContainer');
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        fetch(`${API}/auth/check`, { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (data.authenticated) {
                    document.getElementById('currentUser').textContent = data.username;
                    document.getElementById('userRole').textContent = data.role;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    currentRole = data.role;
                    if (data.role === 'admin') {
                        document.getElementById('adminPanel').style.display = 'block';
                        loadUsers();
                        loadAdminStats();
                    } else {
                        document.getElementById('userPanel').style.display = 'block';
                        loadUserData();
                    }
                }
            });
    </script>
</body>
</html>
